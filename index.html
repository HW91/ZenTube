<!DOCTYPE html>
<html>
<head>
  <title>YouTube Video Filter</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: auto; padding: 20px; }
    input, select, textarea, button { margin: 5px 0; width: 100%; box-sizing: border-box; }
    .video { margin: 10px 0; }
    #loading { display: none; font-style: italic; }
    #error { color: red; }
  </style>
</head>
<body>
  <h1>YouTube Video Filter</h1>

  <label>Search Term:</label>
  <input type="text" id="query" placeholder="e.g. tech reviews">

  <label>Upload Date:</label>
  <select id="uploadDate">
    <option value="any">Any</option>
    <option value="today">Today</option>
    <option value="thisWeek">This Week</option>
    <option value="thisMonth">This Month</option>
  </select>

  <label>Duration:</label>
  <select id="duration">
    <option value="any">Any</option>
    <option value="short">Short (< 4 mins)</option>
    <option value="medium">Medium (4â€“20 mins)</option>
    <option value="long">Long (> 20 mins)</option>
  </select>

  <label>Blocked Terms (comma-separated):</label>
  <input type="text" id="blocked" placeholder="e.g. prank, politics">

  <label><input type="checkbox" id="hideShorts"> Hide Shorts</label>

  <button id="searchBtn">Search</button>
  <p id="loading">Loading results...</p>
  <p id="error"></p>

  <div id="results"></div>

  <script>
    const API_KEY = 'YOUR_API_KEY_HERE';
    const MAX_PAGES = 3;

    // Load saved settings
    function loadSettings() {
      document.getElementById('query').value = localStorage.getItem('query') || '';
      document.getElementById('uploadDate').value = localStorage.getItem('uploadDate') || 'any';
      document.getElementById('duration').value = localStorage.getItem('duration') || 'any';
      document.getElementById('blocked').value = localStorage.getItem('blocked') || '';
      document.getElementById('hideShorts').checked = localStorage.getItem('hideShorts') === 'true';
    }

    // Save current settings
    function saveSettings() {
      localStorage.setItem('query', document.getElementById('query').value);
      localStorage.setItem('uploadDate', document.getElementById('uploadDate').value);
      localStorage.setItem('duration', document.getElementById('duration').value);
      localStorage.setItem('blocked', document.getElementById('blocked').value);
      localStorage.setItem('hideShorts', document.getElementById('hideShorts').checked);
    }

    async function searchVideos() {
      saveSettings();
      const query = document.getElementById('query').value;
      const uploadDate = document.getElementById('uploadDate').value;
      const duration = document.getElementById('duration').value;
      const blockedTermsInput = document.getElementById('blocked').value;
      const hideShorts = document.getElementById('hideShorts').checked;
      const errorEl = document.getElementById('error');
      const loadingEl = document.getElementById('loading');
      const resultsEl = document.getElementById('results');

      errorEl.textContent = '';
      resultsEl.innerHTML = '';
      loadingEl.style.display = 'block';
      disableInputs(true);

      // Prepare regex filters
      const blockedTerms = blockedTermsInput
        .split(',')
        .map(t => t.trim())
        .filter(t => t)
        .map(t => new RegExp(t, 'i'));

      let pageToken = '';
      let results = [];

      try {
        for (let i = 0; i < MAX_PAGES; i++) {
          const url = new URL('https://www.googleapis.com/youtube/v3/search');
          url.search = new URLSearchParams({
            key: API_KEY,
            q: query,
            part: 'snippet',
            maxResults: '25',
            type: 'video',
            videoDuration: duration !== 'any' ? duration : undefined,
            publishedAfter: getPublishedAfter(uploadDate),
            pageToken: pageToken
          });

          const res = await fetch(url);
          if (!res.ok) throw new Error(`API error: ${res.status}`);
          const data = await res.json();
          if (!data.items) break;

          const filtered = data.items.filter(item => {
            const meta = `${item.snippet.title} ${item.snippet.description} ${item.snippet.tags || ''}`;
            const matchesBlocked = blockedTerms.some(rx => rx.test(meta));
            const isShort = /#shorts/i.test(item.snippet.title);
            return !matchesBlocked && (!hideShorts || !isShort);
          });

          results = results.concat(filtered);
          if (!data.nextPageToken) break;
          pageToken = data.nextPageToken;
        }

        displayResults(results);
      } catch (err) {
        errorEl.textContent = 'Error: ' + err.message;
      } finally {
        loadingEl.style.display = 'none';
        disableInputs(false);
      }
    }

    function getPublishedAfter(option) {
      const now = Date.now();
      if (option === 'today') return new Date(now - 86400000).toISOString();
      if (option === 'thisWeek') return new Date(now - 7 * 86400000).toISOString();
      if (option === 'thisMonth') return new Date(now - 30 * 86400000).toISOString();
      return undefined;
    }

    function displayResults(videos) {
      const container = document.getElementById('results');
      if (videos.length === 0) {
        container.innerHTML = '<p>No results found after filtering.</p>';
        return;
      }
      videos.forEach(video => {
        const title = video.snippet.title;
        const url = `https://www.youtube.com/watch?v=${video.id.videoId}`;
        const div = document.createElement('div');
        div.className = 'video';
        div.innerHTML = `<a href="${url}" target="_blank">${title}</a>`;
        container.appendChild(div);
      });
    }

    function disableInputs(disabled) {
      document.getElementById('searchBtn').disabled = disabled;
      ['query','uploadDate','duration','blocked','hideShorts'].forEach(id => {
        document.getElementById(id).disabled = disabled;
      });
    }

    document.getElementById('searchBtn').addEventListener('click', searchVideos);
    window.addEventListener('load', loadSettings);
  </script>
</body>
</html>
